# Sample Application Server

This is a simple Go-based web server designed to simulate a stateful application for auto-scaling test purposes.

It provides basic session management and a few endpoints to represent a typical user workflow. It also exposes a Prometheus-compatible `/metrics` endpoint to report the number of active sessions (`concurrent_connections`).

This server can simulate CPU and Memory load on each API call, configured via environment variables.

## Endpoints

-   `POST /login`: Authenticates a user and returns a session token.
    -   **Body (JSON):** `{"username": "user", "password": "password"}`
    -   **Response (JSON):** `{"token": "..."}`
-   `GET /browse`: Simulates a user browsing data. Requires a valid session token.
    -   **Header:** `Authorization: <token>`
-   `POST /submit`: Simulates a user submitting data. Requires a valid session token.
    -   **Header:** `Authorization: <token>`
    -   **Body (JSON):** Any JSON object.
-   `GET /metrics`: Exposes the `concurrent_connections` metric for Prometheus scraping.

## How to Run

1.  **Tidy Dependencies:**
    From this directory, run `go mod tidy` to fetch the dependencies.

    ```sh
    go mod tidy
    ```

2.  **Run the Server:**
    You can run the server directly using `go run`.

    ```sh
    go run main.go
    ```

    The server will start on port `8080`.

3.  **Build a Binary:**
    To build a self-contained binary:

    ```sh
    go build -o app-server .
    ```

    You can then run the compiled application:

    ```sh
    ./app-server
    ```

## Load Simulation Configuration

You can control the amount of CPU and memory load generated by each API call using the following environment variables:

-   `LOAD_CPU_ITERATIONS`: The number of iterations in a loop to simulate CPU work.
    -   **Default:** `100000`
-   `LOAD_MEM_MB`: The amount of memory in Megabytes to allocate for each request.
    -   **Default:** `1`

**Example:** Run the server with a higher load:
```sh
export LOAD_CPU_ITERATIONS=500000
export LOAD_MEM_MB=10
go run main.go
```

## Example Usage (with curl)

1.  **Login and get a token:**
    ```sh
    TOKEN=$(curl -s -X POST -d '{"username":"testuser"}' http://localhost:8080/login | jq -r .token)
    echo "Got token: $TOKEN"
    ```

2.  **Use the token to access protected endpoints:**
    ```sh
    # Browse content
    curl -H "Authorization: $TOKEN" http://localhost:8080/browse

    # Submit data
    curl -X POST -H "Authorization: $TOKEN" -d '{"answer": 42}' http://localhost:8080/submit
    ```

3.  **Check the metrics:**
    ```sh
    # You should see 1 concurrent connection
    curl http://localhost:8080/metrics
    ```
